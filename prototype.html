<!DOCTYPE html>
<html>

<head>
    <title>prototype</title>
    <script>
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <script href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <style>
        input.form-control {
            width: auto;
        }

        table {
            table-layout: fixed;
        }

        .workday {
            width: 60px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                BASIC
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>內容</th>
                            <th width="150px">開始</th>
                            <th width="150px">結束</th>
                            <th width="100px">工期</th>
                            <th width="100px">前項關聯</th>
                            <th width="400px">其它</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="group1">
                            <td><i class="fa-regular fa-square-check fa-lg"></i> 都審小會掛號</td>
                            <td><input type="date" value="2023-01-04" onchange="changefunc(this)" disabled /></td>
                            <td><input type="date" value="2023-01-04" onchange="changefunc(this)" disabled /></td>
                            <td><input class="form-control" type="number" style="width: 70px;" disabled value="1" />
                            </td>
                            <td>
                                <input class="form-check-input" type="checkbox" disabled />
                                <input class="form-control" type="number" style="width: 70px;" disabled />
                            </td>
                            <td>
                                <input type="button" value="備註" class="btn btn-primary" />
                                <input type="button" value="完成工作" class="btn btn-success" />
                                <input type="button" value="取消工作" class="btn btn-secondary" />
                            </td>
                        </tr>
                        <tr id="group2">
                            <td><i class="fa-regular fa-square fa-lg"></i> 都審小會報告書查核</td>
                            <td><input type="date" value="2023-07-04" onchange="changefunc(this)" max="2023-07-24" />
                            </td>
                            <td><input type="date" value="2023-07-24" onchange="changefunc(this)" min="2023-07-04" />
                            </td>
                            <td><input class="form-control" type="number" style="width: 70px;" value="21"
                                    onchange="changefunc(this)" min="1" /></td>
                            <td>
                                <input class="form-check-input" type="checkbox" checked />
                                <input class="form-control" type="number" value="7" style="width: 70px;" />
                            </td>
                            <td>
                                <input type="button" value="備註" class="btn btn-primary" />
                                <input type="button" value="完成工作" class="btn btn-success" />
                                <input type="button" value="取消工作" class="btn btn-secondary" />
                            </td>
                        </tr>
                        <tr id="group3">
                            <td><i class="fa-regular fa-square fa-lg"></i> 都審小會會前會</td>
                            <td><input type="date" value="2023-07-31" onchange="changefunc(this)" disabled /></td>
                            <td><input type="date" value="2023-07-31" onchange="changefunc(this)" /></td>
                            <td><input class="form-control" type="number" style="width: 70px;" readonly value="1" />
                            </td>
                            <td>
                                <input class="form-check-input" type="checkbox" checked />
                                <input class="form-control" type="number" value="6" style="width: 70px;" />
                            </td>
                            <td>
                                <input type="button" value="備註" class="btn btn-primary" />
                                <input type="button" value="完成工作" class="btn btn-success" />
                                <input type="button" value="取消工作" class="btn btn-secondary" />
                            </td>
                        </tr>
                        <tr id="group4">
                            <td><i class="fa-regular fa-square fa-lg"></i> 都審小會</td>
                            <td><input type="date" value="2023-08-04" onchange="changefunc(this)" disabled /></td>
                            <td><input type="date" value="2023-08-04" onchange="changefunc(this)" /></td>
                            <td><input class="form-control" type="number" style="width: 70px;" readonly value="1" />
                            </td>
                            <td>
                                <input class="form-check-input" type="checkbox" checked />
                                <input class="form-control" type="number" value="7" style="width: 70px;" />
                            </td>
                            <td>
                                <input type="button" value="備註" class="btn btn-primary" />
                                <input type="button" value="完成工作" class="btn btn-success" />
                                <input type="button" value="取消工作" class="btn btn-secondary" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-2">
            <div class="card-header">
                限制條件
            </div>
            <div class="card-body">
                <ul>
                    <li>USER 自行決定該工作是否連動修改</li>
                    <li>已完成工作不套用連動規則</li>
                    <li>前面的工作不套用連動規則(只調整後續工作)</li>
                    <li>特定審查工作工期只有一天，開始日一定等於結束日</li>
                    <li>調整開始或結束日期時，自動推算工期</li>
                    <li>調整工期時，以開始日自動推算結束日</li>
                </ul>
            </div>
        </div>

    </div>
    <script>
        let groupcount = document.querySelectorAll('input').length / 8
        Date.prototype.addDays = function (days) {
            var date = new Date(this.valueOf());
            date.setDate(date.getDate() + days);
            return date;
        }
        function changefunc(sender) {
            let row = sender.closest('tr');
            let inputs = row.querySelectorAll('input');
            if (sender.attributes.type.nodeValue === 'date') {
                // 調整日期動作
                // 檢查開始日等於結束日
                if (inputs[2].readOnly) {
                    // 如果工期唯讀，則開始日等於結束日
                    inputs[0].value = sender.value;
                } else {
                    // 計算工期
                    inputs[2].value = (inputs[1].valueAsDate - inputs[0].valueAsDate) / 86400000 + 1
                    inputs[1].min = inputs[0].value
                    inputs[0].max = inputs[1].value
                }
            } else if (sender.attributes.type.nodeValue === 'number') {
                // 調整工期動作
                let dt = new Date(inputs[0].valueAsDate);
                inputs[1].value = dt.addDays((sender.valueAsNumber - 1)).toISOString().substring(0, 10);
            }
            procMove(sender)
        }
        // 處理工作連動
        function procMove(sender) {
            let row = sender.closest('tr');
            // 取得目前所在組別
            let group = parseInt(row.id.substring(5));
            console.log(' ');
            console.log('current group: ' + group);
            // 如果目前組別小於全部組別數，處理移動日期
            if (group < groupcount) {
                for (let i = group + 1; i <= groupcount; i++) {
                    console.log('proc group: ' + (i));
                    let prevGroup = document.getElementById('group' + (i-1)).querySelectorAll('input');
                    let currentGroup = document.getElementById('group' + i).querySelectorAll('input');
                    if(currentGroup[3].checked){
                        console.log('constraint: '+currentGroup[3].checked);
                        console.log('group' + i + ": " + currentGroup[4].value);
                        currentGroup[1].value = prevGroup[1].valueAsDate.addDays(currentGroup[4].valueAsNumber)
                    }
                }
            }
        }

    </script>
</body>

</html>
